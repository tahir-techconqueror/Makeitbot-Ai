
import { NextRequest, NextResponse } from 'next/server';
import { sendEmail } from '@/server/services/email-service';
import { logger } from '@/lib/logger';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { testContent, recipient, testName } = body;

    if (!testContent) {
      return NextResponse.json({ error: 'Missing testContent' }, { status: 400 });
    }

    const recipientEmail = recipient || 'martez@markitbot.com';
    const subject = `AI Generated Test Results: ${testName || 'Kusho Recording'}`;
    const emailBody = `
      <h1>Here are your AI Generated Tests</h1>
      <p>Generated by Kusho CLI.</p>
      <hr />
      <pre style="background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto;">
${testContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
      </pre>
    `;

    const result = await sendEmail({
      to: recipientEmail,
      subject: subject,
      text: testContent, // Fallback text
      html: emailBody
    });

    if (result) {
      logger.info(`[EmailTestResults] Email sent successfully to ${recipientEmail}`);
      return NextResponse.json({ success: true });
    } else {
      logger.error(`[EmailTestResults] Failed to send email to ${recipientEmail}`);
      return NextResponse.json({ error: 'Failed to send email' }, { status: 500 });
    }
  } catch (error: any) {
    logger.error('[EmailTestResults] Error processing request:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
